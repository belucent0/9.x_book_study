# 9.3 고급 최적화
- 통계 정보 + 옵티마이저 옵션 결합 => 최적의 실행 계획 수립
- 옵티마이저 옵션
    - 조인 관련
    - 옵티마이저 스위치 (MySQL 5.5 버전부터 지원)

## 9.3.1 옵티마이저 스위치 옵션
- MySQL 서버의 고급 최적화 기능 활성화 여부 설정
- GLOBAL/SESSION 변수로 조정 가능 (ON/OFF 값 설정)

### 9.3.1.1 MRR과 배치 키 액세스(mrr & batched_key_access)
- 네스티드 루프 조인(Nested Loop Join)
    - 드라이빙 테이블의 레코드를 한 건 읽어서 드리븐 테이블의 일치하는 레코드를 찾아서 조인 수행
    - 조인은 MySQL 엔진이 처리, 실제 레코드를 읽는 부분은 스토리지 엔진이 처리
        => 따라서, 네스티드 루프 조인은 스토리지 엔진에서는 최적화 불가

- MRR(Multi-Range Read)
    - 네스티드 루프 조인의 단점을 커버하기 위해 나옴
    - 조인 대상 테이블 중 하나로부터 레코드를 읽어서 조인 버퍼에 버퍼링
    - 조인 버퍼에 레코드가 다 차면 스토리지 엔진에 한 번에 요청
    - 이때 데이터 페이지에 정렬된 순서로 접근해서 디스크 읽기를 최소화할 수 있음

- 배치 키 엑세스 조인(Batched Key Access Join, BKA Join)
    - MRR을 응용한 방식
    - 기본적으로는 비활성화 되어 있음
    - **인덱스가 있을 때 사용**

### 9.3.1.2 블록 네스티드 루프 조인(block_nested_loop)
- 블록(block)은 조인 버퍼 사용 여부를 나타냄 (실행 계획 Extra 칼럼: Using Join buffer 문구 표시)
- 조인 버퍼
    - 드리븐 테이블의 **인덱스를 활용할 수 없는 경우** 드라이빙 테이블에서 읽은 레코드를 메모리에 캐시하고
    - 드리븐 테이블과 메모리 캐시를 조인함 => 조인 버퍼
    - join_buffer_size 라는 시스템 변수로 크기 제한 가능
    - 8.0.18 버전부터는 해시 조인 알고리즘 도입 => 실행계획에 Using Join Buffer (block nested loop) 표시되지 않을 수 있음

### 9.3.1.3 인덱스 컨디션 푸시다운(index_condition_pushdown)
- 푸시다운(pushdown): 읽어야 하는 데이터를 줄이는 것
- 인덱스 컨디션 푸시다운: MySQL 5.6 버전부터 인덱스에 포함된 칼럼의 조건이 있다면 모두 같이 모아서 스토리지 엔진으로 전달할 수 있도록 개선됨
    ```sql
    SELECT * FROM employees 
    WHERE last_name='Action' 
    AND first_name LIKE '%sal';
    ```
- employees 테이블에 (last_name, first_name) 으로 이뤄진 `ix_lastname_firstname`라는 인덱스가 있을 때
    - 인덱스 컨디션 푸시다운 기능이 비활성화된 경우: Extra 칼럼에 Using where 조건이 표시됨
        - `first_name LIKE '%sal'`은 인덱스 레인지 스캔에 사용될 수 없으므로 `last_name='Action'` 조건으로 인덱스 레인지 스캔을 한 후, first_name 을 조건으로 찾음
        - 이 경우, 만약 `last_name='Action'` 조건에 일치하는 레코드가 10만 건, 그중 first_name 조건에 일치하는 레코드가 단 1건이라면 매우 비효율적
    - 인덱스 컨디션 푸시다운 기능이 활성화된 경우: `ix_lastname_firstname` 인덱스의 first_name 칼럼을 활용하게 됨
    - 미리 최대한 필터링을 할 수 있음 (= pushdown)